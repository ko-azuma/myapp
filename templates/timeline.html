<!DOCTYPE html>
<html>
<head>
    <title>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</title>
    <link rel="stylesheet" href="../static/css/timeline.css">
</head>
<body>
<div class="container">
    <h1>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h1>

    <div class="nav">
        {% if 'user_id' in session %}
            <a href="{{ url_for('create_post') }}">æ–°è¦æŠ•ç¨¿</a>
            <a href="{{ url_for('users') }}">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a>
            <a href="{{ url_for('logout') }}">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
        {% else %}
            <a href="{{ url_for('login') }}">ãƒ­ã‚°ã‚¤ãƒ³</a>
        {% endif %}
    </div>

    <hr>

    {% for post in posts %}
        <div class="post-card">
            <div class="post-header">
                <strong>{{ post.user.name }}</strong>
                <span class="timestamp">{{ post.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>

                <!-- æŠ•ç¨¿å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆæœ¬äººã®ã¿ï¼‰ -->
                {% if 'user_id' in session and post.user_id == session['user_id'] %}
                    <form class="delete-post-form" action="{{ url_for('delete_post', post_id=post.id) }}" method="post" onsubmit="return confirmDelete('æŠ•ç¨¿')">
                        <button type="submit" class="delete-btn">Ã—</button>
                    </form>
                {% endif %}
            </div>

            <!-- æŠ•ç¨¿å†…å®¹ -->
            <div class="post-content" id="view-{{ post.id }}">
                {{ post.content }}
            </div>

            <!-- ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæœ¬äººã®ã¿ï¼‰ -->
            {% if 'user_id' in session and post.user_id == session['user_id'] %}
                <form class="edit-form" id="edit-{{ post.id }}" action="{{ url_for('edit_post', post_id=post.id) }}" method="post">
                    <textarea name="content" maxlength="200" rows="3">{{ post.content }}</textarea>
                    <div class="edit-buttons">
                        <button type="submit">ä¿å­˜</button>
                        <button type="button" onclick="cancelEdit(this)">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
                <button class="edit-btn" type="button" data-post-id="{{ post.id }}" onclick="startEdit(this)">ç·¨é›†</button>
            {% endif %}

            <!-- ã„ã„ã­ãƒœã‚¿ãƒ³ -->
            <div class="post-actions">
                {% if 'user_id' in session %}
                    <form action="{{ url_for('like', post_id=post.id) }}" method="post" style="display:inline;">
                        <button type="submit">ğŸ‘ {{ post.like_count }}</button>
                    </form>
                {% else %}
                    ğŸ‘ {{ post.like_count }}
                {% endif %}
            </div>

            <!-- ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ -->
            <div class="comments-section">
                {% for comment in post.comments %}
                    <div class="comment">
                        <strong>{{ comment.user.name }}</strong>{{ comment.content }}
                        <span class="comment-timestamp">{{ comment.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>

                        {% if 'user_id' in session and comment.user_id == session['user_id'] %}
                            <form class="delete-comment-form" action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="post" onsubmit="return confirmDelete('ã‚³ãƒ¡ãƒ³ãƒˆ')">
                                <button type="submit" class="delete-btn">Ã—</button>
                            </form>
                        {% endif %}
                    </div>
                {% else %}
                    <p class="no-comments">ã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
                {% endfor %}

                {% if 'user_id' in session %}
                    <form class="comment-form" action="{{ url_for('add_comment', post_id=post.id) }}" method="post">
                        <input type="text" name="content" maxlength="200" placeholder="è¿”ä¿¡ã‚’å…¥åŠ›" required>
                        <button type="submit">è¿”ä¿¡</button>
                    </form>
                {% endif %}
            </div>
        </div>
    {% else %}
        <p>æŠ•ç¨¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endfor %}
</div>

<script>
function startEdit(button) {
    const id = button.dataset.postId;
    document.getElementById("view-" + id).style.display = "none";
    document.getElementById("edit-" + id).style.display = "block";
}

function cancelEdit(button) {
    const form = button.closest("form");
    const id = form.id.replace("edit-", "");
    form.style.display = "none";
    document.getElementById("view-" + id).style.display = "block";
}

// å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
function confirmDelete(type) {
    return confirm(`æœ¬å½“ã«ã“ã®${type}ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`);
}
</script>
</body>
</html>
