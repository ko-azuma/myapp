<!DOCTYPE html>
<html>
<head>
    <title>„Çø„Ç§„É†„É©„Ç§„É≥</title>
    <link rel="stylesheet" href="../static/css/timeline.css">
</head>
<body>
<div class="container">
    <h1>„Çø„Ç§„É†„É©„Ç§„É≥</h1>

    <div class="nav">
        {% if 'user_id' in session %}
            <a href="{{ url_for('create_post') }}">Êñ∞Ë¶èÊäïÁ®ø</a>
            <a href="{{ url_for('users') }}">„É¶„Éº„Ç∂„Éº‰∏ÄË¶ß</a>
            <a href="{{ url_for('logout') }}">„É≠„Ç∞„Ç¢„Ç¶„Éà</a>
        {% else %}
            <a href="{{ url_for('login') }}">„É≠„Ç∞„Ç§„É≥</a>
        {% endif %}
    </div>

    <hr>

    {% for post in posts %}
        <div class="post-card">
            <div class="post-header">
                <strong>{{ post.user.name }}</strong>
                <span class="timestamp">{{ post.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>

                {% if 'user_id' in session and post.user_id == session['user_id'] %}
                    <form class="delete-post-form" action="{{ url_for('delete_post', post_id=post.id) }}" method="post" onsubmit="return confirmDelete('ÊäïÁ®ø')">
                        <button type="submit" class="delete-btn">√ó</button>
                    </form>
                {% endif %}
            </div>

            <div class="post-content" id="view-{{ post.id }}">
                {{ post.content }}
            </div>

            {% if 'user_id' in session and post.user_id == session['user_id'] %}
                <form class="edit-form" id="edit-{{ post.id }}" action="{{ url_for('edit_post', post_id=post.id) }}" method="post" style="display:none;">
                    <textarea name="content" maxlength="200" rows="3">{{ post.content }}</textarea>
                    <div class="edit-buttons">
                        <button type="submit">‰øùÂ≠ò</button>
                        <button type="button" onclick="cancelEdit(this)">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
                <button class="edit-btn" type="button" data-post-id="{{ post.id }}" onclick="startEdit(this)">Á∑®ÈõÜ</button>
            {% endif %}

            <div class="post-actions">
                {% if 'user_id' in session %}
                    <form action="{{ url_for('like', post_id=post.id) }}" method="post" style="display:inline;">
                        <button type="submit">üëç {{ post.like_count }}</button>
                    </form>
                {% else %}
                    üëç {{ post.like_count }}
                {% endif %}
            </div>

            <!-- „Ç≥„É°„É≥„ÉàÊ¨Ñ -->
            <div class="comments-section">
                {% for comment in post.comments %}
                    <div class="comment">
                        <div class="comment-username">{{ comment.user.name }}</div>

                        <div class="comment-body">
                            <div class="comment-content">{{ comment.content }}</div>
                            <span class="comment-timestamp">{{ comment.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>

                        {% if 'user_id' in session and comment.user_id == session['user_id'] %}
                            <form class="delete-comment-form"
                                  action="{{ url_for('delete_comment', comment_id=comment.id) }}"
                                  method="post"
                                  onsubmit="return confirmDelete('„Ç≥„É°„É≥„Éà')">
                                <button type="submit" class="delete-btn">√ó</button>
                            </form>
                        {% endif %}
                    </div>
                {% else %}
                    <p class="no-comments">„Ç≥„É°„É≥„Éà„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                {% endfor %}

                {% if 'user_id' in session %}
                    <form class="comment-form" action="{{ url_for('add_comment', post_id=post.id) }}" method="post">
                        <input type="text" name="content" maxlength="200" placeholder="Ëøî‰ø°„ÇíÂÖ•Âäõ" required>
                        <button type="submit">Ëøî‰ø°</button>
                    </form>
                {% endif %}
            </div>
        </div>
    {% else %}
        <p>ÊäïÁ®ø„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
    {% endfor %}
</div>

<script>
function startEdit(button) {
    const id = button.dataset.postId;
    document.getElementById("view-" + id).style.display = "none";
    document.getElementById("edit-" + id).style.display = "block";
}

function cancelEdit(button) {
    const form = button.closest("form");
    const id = form.id.replace("edit-", "");
    form.style.display = "none";
    document.getElementById("view-" + id).style.display = "block";
}

function confirmDelete(type) {
    return confirm(`Êú¨ÂΩì„Å´„Åì„ÅÆ${type}„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`);
}
</script>
</body>
</html>
